#!/bin/bash

# -------------------------------------------------------------------------- #
# Copyright 2010-2012, C12G Labs S.L.                                        #
#                                                                            #
# Licensed under the Apache License, Version 2.0 (the "License"); you may    #
# not use this file except in compliance with the License. You may obtain    #
# a copy of the License at                                                   #
#                                                                            #
# http://www.apache.org/licenses/LICENSE-2.0                                 #
#                                                                            #
# Unless required by applicable law or agreed to in writing, software        #
# distributed under the License is distributed on an "AS IS" BASIS,          #
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.   #
# See the License for the specific language governing permissions and        #
# limitations under the License.                                             #
#--------------------------------------------------------------------------- #

# Gets IP address from a given MAC
mac2ip() {
    mac=$1

    let ip_a=0x`echo $mac | cut -d: -f 3`
    let ip_b=0x`echo $mac | cut -d: -f 4`
    let ip_c=0x`echo $mac | cut -d: -f 5`
    let ip_d=0x`echo $mac | cut -d: -f 6`

    ip="$ip_a.$ip_b.$ip_c.$ip_d"

    echo $ip
}

# Gets the network part of an IP
get_network() {
    network=$(get_iface_var "NETWORK")

    if [ -z "$network" ]; then
        network="$(echo $IP | cut -d'.' -f1,2,3).0"
    fi

    echo $network
}

# Gets the network mask
get_mask() {
    mask=$(get_iface_var "MASK")

    if [ -z "$mask" ]; then
        mask="255.255.255.0"
    fi

    echo $mask
}

# Gets the network gateway
get_gateway() {
    gateway=$(get_iface_var "GATEWAY")

    if [ -z "$gateway" ]; then
        if [ "$DEV" = "eth0" ]; then
            net_prefix=$(echo $NETWORK | cut -d'.' -f1,2,3)
            gateway="${net_prefix}.1"
        fi
    fi

    echo $gateway
}

get_interfaces() {
    IFCMD="/sbin/ifconfig -a"

    $IFCMD | grep ^eth | sed 's/ *Link encap:Ethernet.*HWaddr /-/g'
}

get_dev() {
    echo $1 | cut -d'-' -f 1
}

get_mac() {
    echo $1 | cut -d'-' -f 2
}

get_ip() {
    ip=$(get_iface_var "IP")

    if [ -z "$ip" ]; then
        ip=$(mac2ip $MAC)
    fi

    echo $ip
}

get_iface_var() {
    var_name="${UPCASE_DEV}_$1"
    var=$(eval "echo \"\${$var_name}\"")

    echo $var
}

upcase() {
    echo "$*" | tr '[:lower:]' '[:upper:]'
}

gen_iface_conf() {
    cat <<EOT
DEVICE=$DEV
BOOTPROTO=none
ONBOOT=yes
TYPE=$TYPE
NETMASK=$MASK
IPADDR=$IP
EOT

    if [ -n "$GATEWAY" ]; then
      echo "GATEWAY=$GATEWAY"
    fi

    echo ""
}

gen_network_configuration()
{
    IFACES=`get_interfaces`

    for i in $IFACES; do
	MAC=`get_mac $i`

        ib_vf=$(echo "$MAC" | cut -c 1-2)
        ib_pos=$(echo "$MAC" | cut -c 5)

        #DEV=`get_dev $i`
        #UPCASE_DEV=`upcase $DEV`

        if  [ "$ib_vf" == "AA" ]; then
          DEV="ib"$ib_pos
          UPCASE_DEV=`upcase $DEV`
          TYPE="Infiniband"
        else
          DEV=`get_dev $i`
          UPCASE_DEV=`upcase $DEV`
          TYPE="Ethernet"
        fi

        IP=$(get_ip)
        NETWORK=$(get_network)
        MASK=$(get_mask)
        GATEWAY=$(get_gateway)

        if  [ "$ib_vf" == "AA" ]; then
          gen_iface_conf > /etc/sysconfig/network-scripts/ifcfg-ib$ib_pos
        else
          gen_iface_conf > /etc/sysconfig/network-scripts/ifcfg-${DEV}
        fi
    done

    down_ifs=`ip addr | grep "mtu" | wc -l`
    position=0
    while [ $position -lt $down_ifs ] 
    do
	position=$[$position + 1]
	is_ib=`ip addr | grep "mtu" -A 1 | grep link/ | sed "$position q;d" | grep infiniband | wc -l`
	if [ $is_ib -gt 0 ]; then
	  DEV=`ip addr | grep "mtu" | sed "$position q;d" | awk '{print $2}' | cut -d ":" -f1`
	  if [ ! -f /etc/sysconfig/network-scripts/ifcfg-${DEV} ]; then
	    MAC=`ip addr | grep "mtu" -A 1 | grep link/ | sed "$position q;d" | awk '{print $2}' | rev | cut -c -17 | rev`
	    UPCASE_DEV=`upcase $DEV`
	    TYPE="Infiniband"
	    IP=$(get_ip)
	    NETWORK=$(get_network)
	    MASK=$(get_mask)
	    GATEWAY=$(get_gateway)
	    echo "Writing"
	    gen_iface_conf > /etc/sysconfig/network-scripts/ifcfg-${DEV}
	  fi
	fi
    done

}

configure_network()
{
    gen_network_configuration

    service network restart

    /root/set_hostname.sh

    sleep 2
}

configure_network

